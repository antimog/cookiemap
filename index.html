<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ottawa Cookie Spots — Interactive Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }
    .legend {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.3;
    }
    .legend h1 {
      font-size: 16px;
      margin: 0 0 6px 0;
    }
    .legend .status {
      font-size: 12px;
      color: #555;
      margin-top: 6px;
    }
    .footer-note {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 8px 10px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      font-size: 12px;
    }
    .list {
      margin-top: 6px;
      max-height: 160px;
      overflow: auto;
    }
    .list div {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 2px 0;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 50%; background: #2e7d32; display: inline-block;
    }
    .dot.pending { background: #f9a825; }
    .dot.error { background: #c62828; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend" id="legend">
    <h1>Ottawa Cookie Spots</h1>
    <div>Markers are placed by live geocoding (Nominatim/OSM).</div>
    <div class="status" id="status">Starting geocoding…</div>
    <div class="list" id="list"></div>
  </div>
  <div class="footer-note">
    Tip: Click a marker to see the name and formatted address. Drag to move, scroll to zoom.
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // List of places provided, scoped to Ottawa, Ontario
    const places = [
      "Union Street Kitchen Cafe 42 Crichton St, Ottawa ON K1M 1V4",
      "Cafe Deluxe",
      "Bread and Sons",
      "Toro",
      "Craig’s",
      "Stuffed Cookies by Kat",
      "Dessert First",
      "Costco",
      "Harmony health clinic food counter",
      "Crumbl",
      "Hello dolly",
      "Chippers",
      "Pasticerria gelateria italiana",
      "Nutty greek",
      "Corner peach",
      "Greek souvlaki shack",
      "Three Tarts 464 Bank St, Ottawa ON K2P 1Z3",
      "Pizza nerds",
      "Mandy’s"
    ];

    // Initialize the map centered on Ottawa
    const map = L.map('map').setView([45.4215, -75.6972], 12);

    // Basemap (OSM)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const bounds = L.latLngBounds();
    const listEl = document.getElementById('list');
    const statusEl = document.getElementById('status');

    function createListItem(name) {
      const row = document.createElement('div');
      const dot = document.createElement('span');
      dot.className = 'dot pending';
      row.appendChild(dot);
      const text = document.createElement('span');
      text.textContent = name;
      row.appendChild(text);
      listEl.appendChild(row);
      return { row, dot, text };
    }

    const delay = (ms) => new Promise(res => setTimeout(res, ms));

    async function geocode(query) {
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('format', 'json');
      url.searchParams.set('limit', '1');
      url.searchParams.set('addressdetails', '1');
      const scope = /ottawa|ontario|on\s*\b/i.test(query) ? query : `${query}, Ottawa, Ontario, Canada`;
      url.searchParams.set('q', scope);
      const resp = await fetch(url.toString(), {
        headers: { 'Accept': 'application/json' }
      });
      if (!resp.ok) throw new Error('Geocoding failed: ' + resp.status);
      const data = await resp.json();
      if (!data || data.length === 0) throw new Error('No results');
      return data[0];
    }

    (async function run() {
      statusEl.textContent = `Geocoding ${places.length} locations…`;
      let success = 0, failures = 0;

      for (let i = 0; i < places.length; i++) {
        const name = places[i];
        const item = createListItem(name);
        try {
          await delay(1100);
          const result = await geocode(name);
          const lat = parseFloat(result.lat);
          const lon = parseFloat(result.lon);
          const display = result.display_name || 'Address unavailable';

          const marker = L.marker([lat, lon]).addTo(map);
          marker.bindPopup(`<strong>${name}</strong><br>${display}`);

          bounds.extend([lat, lon]);
          item.dot.className = 'dot';
          item.text.textContent = `${name} — placed`;
          success += 1;
        } catch (err) {
          item.dot.className = 'dot error';
          item.text.textContent = `${name} — not found`;
          failures += 1;
          console.warn('Geocoding error for', name, err);
        }
      }

      if (success > 0) {
        map.fitBounds(bounds.pad(0.15));
      }
      statusEl.textContent = `Done. Placed: ${success} • Not found: ${failures}`;
    })();
  </script>
</body>
</html>
